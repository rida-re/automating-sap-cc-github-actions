name: CI/CD - CCv2 Build & Deploy

env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  BUILD_NAME: SAPCOMMERCE.BUILD.$(date +'%Y.%m.%d.%H.%M')
  DATABASE_UPDATE_MODE: UPDATE
  DEPLOYMENT_STRATEGY: ROLLING_UPDATE
  ENVIRONMENT_CODE: d1
  CCV2_URL: https://sap-commerce-cloud-ccv2-mock.free.beeceptor.com/v2/subscriptions
  CCV2_AUTH_ACCESS_TOKEN: ${{ secrets.CCV2_AUTH_ACCESS_TOKEN }}
  CCV2_SUBSCRIPTION_CODE: ${{ secrets.CCV2_SUBSCRIPTION_CODE }}
  CCV2_BASE_URL: https://sap-commerce-cloud-ccv2-mock.free.beeceptor.com/v2/subscriptions/${{secrets.CCV2_SUBSCRIPTION_CODE}}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

on:
  push:
    branches:
      - 'release/**'
      - develop
      - main
  pull_request:
    branches:
      - develop
      - main
  workflow_dispatch:

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Clone external Cyber Solutions repo
        run: |
          git clone --depth=1 https://github.com/rida-re/cyber-solutions.git external_project
          echo "Cloned external_project. Showing top-level:"
          ls -la external_project || true

      - name: Debug full structure (quick)
        run: |
          echo "Working dir: $(pwd)"
          echo "List /github/workspace (top level)"
          ls -la .
          echo "List external_project/bin/custom (if exists)"
          [ -d external_project/bin/custom ] && ls -la external_project/bin/custom || echo "no bin/custom"
          echo "List external_project/bin/custom/cybersolutions (if exists)"
          [ -d external_project/bin/custom/cybersolutions ] && ls -la external_project/bin/custom/cybersolutions || echo "no cybersolutions"
          # If your project uses other folders (e.g. hybris/bin/platform or extensions), show them too:
          [ -d external_project/bin ] && ls -la external_project/bin || true

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache SonarQube packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: SonarCloud Analysis
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          # point projectBaseDir to the folder that actually contains the sources you want scanned.
          # Replace this value if your sources are elsewhere (see the Debug step output above).
          projectBaseDir: external_project/bin/custom/cybersolutions
          # pass sonar scanner args; sonar.sources is set to '.' because projectBaseDir is the base
          args: >
            -Dsonar.projectKey=${{ github.repository_owner }}_cyber-solutions
            -Dsonar.organization=rida
            -Dsonar.sources=.
            -Dsonar.sourceEncoding=UTF-8
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Clone external Cyber Solutions project
        run: |
          git clone --depth=1 https://github.com/rida-re/cyber-solutions.git external_project
          ls external_project/bin/custom/cybersolutions

      - name: Run npm audit (if applicable)
        run: |
          if [ -f external_project/bin/custom/cybersolutions/package.json ]; then
            cd external_project/bin/custom/cybersolutions
            npm audit
          else
            echo "No package.json found, skipping npm audit"
          fi

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Cyber Solutions'
          path: 'external_project/bin/custom/cybersolutions'
          format: 'HTML'
          args: >
            --scan external_project/bin/custom/cybersolutions \
            --failOnCVSS 7 \
            --enableExperimental \
            --exclude "**/*.java" \
            --exclude "**/*.class"

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-output
          path: dist/

  SAPCOM_BUILD_AND_DEPLOY_JOB:
    needs: [code-quality, security-scan]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Debug secrets presence
        run: |
          if [ -z "${CCV2_AUTH_ACCESS_TOKEN}" ]; then
            echo "CCV2_AUTH_ACCESS_TOKEN is EMPTY"
          else
            echo "CCV2_AUTH_ACCESS_TOKEN is SET"
          fi
          if [ -z "${CCV2_SUBSCRIPTION_CODE}" ]; then
            echo "CCV2_SUBSCRIPTION_CODE is EMPTY"
          else
            echo "CCV2_SUBSCRIPTION_CODE is SET"
          fi
        shell: bash

      - name: Create Build
        run: |
          #!/bin/bash
          echo "URL: ${{env.CCV2_BASE_URL}}"
          echo "BUILD_NAME : ${{ env.BUILD_NAME }}"
          ccv2_build_url="${{env.CCV2_BASE_URL}}/builds";
          payload='{"branch": "'"${BRANCH_NAME}"'", "name": "'"${BUILD_NAME}"'"}';
          echo "Payload :: $payload"
          buildcode=$(curl --location --request POST "$ccv2_build_url" \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{env.CCV2_AUTH_ACCESS_TOKEN}}" \
            --data-raw "$payload" | jq -r '.code')
          echo "buildcode=$buildcode" >> $GITHUB_ENV
          echo "Create Build Response:  $buildcode"

      - name: Check Build Progress
        run: |
          echo "Check Build progress of buildcode : $buildcode"
          ccv2_build_url="${{env.CCV2_BASE_URL}}/builds";
          while true; do
              progress_ccv2_build_url="$ccv2_build_url/$buildcode/progress"
              echo "URL: $progress_ccv2_build_url"
              buildresponse=$(curl --location --request GET "$progress_ccv2_build_url" \
                --header "Authorization: Bearer ${{env.CCV2_AUTH_ACCESS_TOKEN}}")
              buildStatus=$(echo "$buildresponse" | jq -r '.status')
              percentage=$(echo "$buildresponse" | jq -r '.percentage')
              echo "Check Progress Status: $buildStatus"
              if [ "$buildStatus" = "SUCCESS" ]; then
                echo "Build Succeeded"
                break
              elif [ "$buildStatus" = "FAIL" ]; then
                echo "Build Failed"
                exit 1
              else
                echo "Build in progress... $percentage% completed"
                sleep 600
              fi
          done
          echo "Build Completed"
        shell: bash

      - name: Create Deployment
        run: |
          #!/bin/bash
          echo "URL: ${{env.CCV2_BASE_URL}}"
          ccv2_deployment_url="${{env.CCV2_BASE_URL}}/deployments";
          echo "Deployment URL: $ccv2_deployment_url"
          environmentCode="${{env.ENVIRONMENT_CODE}}";
          if [[ $BRANCH_NAME == "release/"* ]]; then
            environmentCode="s1"
          fi
          payload='{"buildCode": "'"$buildcode"'", "databaseUpdateMode": "UPDATE", "environmentCode": "'"$environmentCode"'", "strategy": "ROLLING_UPDATE"}';
          echo "Payload: $payload"
          deploymentcode=$(curl --location --request POST "$ccv2_deployment_url" \
            --header 'Content-Type: application/json' \
            --header "Authorization: Bearer ${{env.CCV2_AUTH_ACCESS_TOKEN}}" \
            --data-raw "$payload" | jq -r '.code')
          echo "deploymentcode=$deploymentcode" >> $GITHUB_ENV
          echo "Create Deployment Response: $deploymentcode"

      - name: Check Deployment Progress
        run: |
          echo "Check Deployment progress of deployment code : $deploymentcode"
          ccv2_deployment_url="${{env.CCV2_BASE_URL}}/deployments";
          while true; do
              ccv2_deployment_progress_url="$ccv2_deployment_url/$deploymentcode/progress"
              echo "URL: $ccv2_deployment_progress_url"
              deploymentresponse=$(curl --location --request GET "$ccv2_deployment_progress_url" \
                --header "Authorization: Bearer ${{env.CCV2_AUTH_ACCESS_TOKEN}}")
              deploymentStatus=$(echo "$deploymentresponse" | jq -r '.deploymentStatus')
              percentage=$(echo "$deploymentresponse" | jq -r '.percentage')
              echo "Check Progress Status: $deploymentStatus"
              if [ "$deploymentStatus" = "DEPLOYED" ]; then
                echo "Deployment Succeeded"
                break
              elif [ "$deploymentStatus" = "FAIL" ]; then
                echo "Deployment Failed"
                exit 1
              else
                echo "Deployment in progress... $percentage% completed"
                sleep 600
              fi
          done
          echo "Deployment Completed"
        shell: bash
