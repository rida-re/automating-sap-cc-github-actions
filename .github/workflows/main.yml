## Workflow for building and deploying into SAP Commerce cloud CCV2 dev and staging envs
env:
  BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
  BUILD_NAME:  SAPCOMMERCE.BUILD.$(date +'%Y.%m.%d.%H.%M')
  DATABASE_UPDATE_MODE: UPDATE
  DEPLOYMENT_STRATEGY: ROLLING_UPDATE
  ENVIRONMENT_CODE: d1
  #CCV2_URL: https://portalrotapi.hana.ondemand.com/v2/subscriptions
  CCV2_URL: https://sap-commerce-cloud-ccv2-mock.free.beeceptor.com/v2/subscriptions
  CCV2_AUTH_ACCESS_TOKEN: ${{ secrets.CCV2_AUTH_ACCESS_TOKEN }}
  CCV2_SUBSCRIPTION_CODE: ${{ secrets.CCV2_SUBSCRIPTION_CODE }}
  #CCV2_BASE_URL : https://portalrotapi.hana.ondemand.com/v2/subscriptions/${{secrets.CCV2_SUBSCRIPTION_CODE}}
  CCV2_BASE_URL : https://sap-commerce-cloud-ccv2-mock.free.beeceptor.com/v2/subscriptions/${{secrets.CCV2_SUBSCRIPTION_CODE}}
on:
  push:
    branches:
      - 'release/**'
      - main
  workflow_dispatch:
jobs:
  SAPCOM_BUILD_AND_DEPLOY_JOB:
    runs-on: ubuntu-latest
    steps:
      - name: Debug secrets presence
        run: |
          if [ -z "${CCV2_AUTH_ACCESS_TOKEN}" ]; then
            echo "CCV2_AUTH_ACCESS_TOKEN is EMPTY"
          else
            echo "CCV2_AUTH_ACCESS_TOKEN is SET"
          fi
          if [ -z "${CCV2_SUBSCRIPTION_CODE}" ]; then
            echo "CCV2_SUBSCRIPTION_CODE is EMPTY"
          else
            echo "CCV2_SUBSCRIPTION_CODE is SET"
          fi
        shell: bash
      - name: Create Build
        run: |
          #!/bin/bash
          echo "URL: ${{env.CCV2_BASE_URL}}"
          echo "URL: ${{secrets.CCV2_SUBSCRIPTION_CODE}}"
          echo "BUILD_NAME : ${{ env.BUILD_NAME }}"
          ccv2_build_url="${{env.CCV2_BASE_URL}}/builds";
          payload='{"branch": "'"${BRANCH_NAME}"'", "name": "'"${BUILD_NAME}"'"}';
          # Use runtime shell variables (BRANCH_NAME and BUILD_NAME) and show payload
          echo "Payload :: $payload"
          echo "ccv2_build_url :: $ccv2_build_url"
          # Extract raw code string with jq -r so it has no surrounding quotes
          buildcode=$(curl --location --request POST "$ccv2_build_url" --header 'Content-Type: application/json' --header "Authorization: Bearer ${{env.CCV2_AUTH_ACCESS_TOKEN}}" --data-raw "$payload" | jq -r '.code')
          echo "buildcode=$buildcode" >> $GITHUB_ENV
          echo "Create Build Response:  $buildcode"
      - name: Check Build Progress
        run: |
         echo "Check Build progress of buildcode : $buildcode"
         ccv2_build_url="${{env.CCV2_BASE_URL}}/builds";
         while true; do
              echo "checkBuild buildcode : $buildcode"
              progress_ccv2_build_url="$ccv2_build_url/$buildcode/progress"
              echo "URL: $progress_ccv2_build_url"
              buildresponse=$(curl --location --request GET "$progress_ccv2_build_url" --header "Authorization: Bearer ${{env.CCV2_AUTH_ACCESS_TOKEN}}")
              # Parse JSON response correctly and extract raw values
              buildStatus=$(echo "$buildresponse" | jq -r '.buildStatus')
              percentage=$(echo "$buildresponse" | jq -r '.percentage')
              echo "Check Progress Status: $buildStatus"
              if [ "$buildStatus" = "SUCCESS" ]; then
                echo "Build Succeeded"
                break
              elif [ "$buildStatus" = "FAIL" ]; then
                echo "Failed"
                exit 1
              else
                echo "Build inProgress.. $percentage % completed"
                sleep 600
              fi
         done
         echo "Build Completed"
        shell: bash
      - name: Create Deployment
        run: |
          #!/bin/bash
          echo "URL: ${{env.CCV2_BASE_URL}}"
          ccv2_deployment_url="${{env.CCV2_BASE_URL}}/deployments";
          echo "Deployment URL: $ccv2_deployment_url"
          echo "Branch name: $BRANCH_NAME"
          environmentCode="${{env.ENVIRONMENT_CODE}}";
          if [[ $BRANCH_NAME == "release/"* ]]; then
            environmentCode="s1"
          fi
          # Ensure buildcode is quoted in JSON payload
          payload='{"buildCode": "'"$buildcode"'", "databaseUpdateMode": "UPDATE", "environmentCode": "'"$environmentCode"'", "strategy": "ROLLING_UPDATE"}';
          echo "Payload: $payload"
          deploymentcode=$(curl --location --request POST "$ccv2_deployment_url" --header 'Content-Type: application/json' --header "Authorization: Bearer ${{env.CCV2_AUTH_ACCESS_TOKEN}}" --data-raw "$payload" | jq -r '.code')
          echo "deploymentcode=$deploymentcode" >> $GITHUB_ENV
          echo "Create Deployment Response:  $deploymentcode" 
      - name: Check Deployment Progress
        run: |
         echo "Check Deployment progress of deployment code : $deploymentcode"
         ccv2_deployment_url="${{env.CCV2_BASE_URL}}/deployments";
         while true; do
              echo "checkdeployment progress for code : $deploymentcode"
              ccv2_deployment_progress_url="$ccv2_deployment_url/$deploymentcode/progress"
              echo "URL: $ccv2_deployment_progress_url"
              deploymentresponse=$(curl --location --request GET "$ccv2_deployment_progress_url" --header "Authorization: Bearer ${{env.CCV2_AUTH_ACCESS_TOKEN}}")
              deploymentStatus=$(echo "$deploymentresponse" | jq -r '.deploymentStatus')
              percentage=$(echo "$deploymentresponse" | jq -r '.percentage')
              echo "Check Progress Status: $deploymentStatus"
              if [ "$deploymentStatus" = "DEPLOYED" ]; then
                echo "Deployment Succeeded"
                break
              elif [ "$deploymentStatus" = "FAIL" ]; then
                echo "Failed"
                exit 1
              else
                echo "Deployment inProgress.. $percentage % completed"
                sleep 600
              fi
         done
         echo "Deployment Completed"
        shell: bash